#!/usr/bin/env node
require('dotenv').config()

const { Sentry, initializeSentry } = require('../lib/config/sentry')

initializeSentry()

const statsd = require('../lib/config/statsd')
const { Subscription } = require('../lib/models')

Subscription.syncStatusCounts().then((results) => {
  results.forEach((row) => {
    statsd.gauge('syncs', row.count, { status: row.syncStatus })
  })

  // Close client, triggering flush of metrics, then exit.
  // (Without exit, process hangs. Without close, metric is never sent.)
  statsd.close(() => {
    process.exit()
  })
}).catch((error) => {
  console.log('An error occurred while sending sync status metrics:', error)
  Sentry.captureException(error)
  process.exit(1)
})
