buildNumber: 0.0.0
name: Github For Jira
description: Connect app for integrating GitHub into Jira
organization: Engineering-DevOps
notifications:
  email: fusion-arc@atlassian.com

compose:
  microservice:
    image: ${DOCKER_IMAGE_NAME}
    tag: ${DOCKER_IMAGE_TAG}
    ports:
      - 8080:8080

computeClassification:
  dataType:
    - UGC/Label                # name of GitHub org / Jira site
    - PII/IndirectConfidential # name of GitHub org
    - UGC/Configuration        # data about the installation of the GitHub app into Jira sites
    - Security/Secret          # shared Connect secret
    - UGC/PrimaryIdentifier    # references to GitHub entities (commits, pull requests, etc.) and Jira issues
    - UGC/Primary              # GitHub entities (non-persistent) like commits, pull requests, etc.

links:
  healthcheck:
    uri: healthcheck
  deepcheck:
    uri: deepcheck
  source:
    url: git@bitbucket.org:atlassian/github-jira-integration.git

cleanup: true

resources:
  - type: redis
    name: bottleneck
    attributes:
      snapshotRetention: 0
      config:
        maxmemory-policy: allkeys-lru
      dataType:
        - UGC/Label                # name of GitHub org / Jira site
        - PII/IndirectConfidential # name of GitHub org
        - UGC/PrimaryIdentifier    # references to GitHub entities (commits, pull requests, etc.) and Jira issues

  - name: rds
    type: dedicated-rds
    attributes:
      dataType:
        - UGC/Label                # name of GitHub org / Jira site
        - PII/IndirectConfidential # name of GitHub org
      parameters:
        DBType: postgres125

  - name: database
    type: postgres-db
    attributes:
      dataType:
        - UGC/Label                # name of GitHub org / Jira site
        - PII/IndirectConfidential # name of GitHub org
        - UGC/Configuration        # data about the installation of the GitHub app into Jira sites
        - Security/Secret          # shared Connect secret
      dedicatedRds:
        # Name of the service that owns the RDS
        service: github-for-jira
        # Name of the RDS resource from above
        resource: rds

  - type: globaledge
    name: ingress
    attributes:
      ip_whitelist:
        - public

scaling:
  instance: t2.small
  min: 1
  max: 5
  metrics:
    CPUUtilization:
      Threshold:
        Lower: 10
        Upper: 90
      Period:
        Lower: 300
        Upper: 120
      EvaluationPeriods: 2

config:
  environmentVariables:
    NODE_ENV: production
    NODE_OPTIONS: "--no-deprecation"
    LOG_LEVEL: info
    PORT: "8080"
    # These secret environment variables need to be stashed with "atlas micros stash" for each environment:
    # GITHUB_CLIENT_SECRET: GitHub app's client secret
    # PRIVATE_KEY: contents of your (*.pem) generated in the GitHub app
    # STORAGE_SECRET: secret generated by running openssl rand -hex 32
    # SENTRY_DSN: client key required to connect to Sentry
    # WEBHOOK_SECRET: the webhook secret configured in the GitHub app

workers:
  - name: Worker
    scaling:
      instance: t2.small
      min: 1
      max: 5
      metrics:
        CPUUtilization:
          Threshold:
            Lower: 10
            Upper: 90
          Period:
            Lower: 300
            Upper: 120
          EvaluationPeriods: 2


environmentOverrides:
  ddev:
    loadBalancer:
      type: ELB # needed for remote debugging, default is "ALB"
    compose:
      microservice:
        ports:
          - 8080:8080
          - 5005:5005 # remote debugging port (has to be 5005 because that is hard coded into Micros)
    links:
      remoteDebug: true
    config:
      environmentVariables:
        APP_URL: https://github-for-jira.dev.services.atlassian.com
        WEBHOOK_PROXY_URL: https://github-for-jira.dev.services.atlassian.com/github/events
        INSTANCE_NAME: github-for-jira-dev
        NODE_OPTIONS: "--no-deprecation"
        LOG_LEVEL: debug
        SENTRY_ENVIRONMENT: ddev
        APP_ID: '124403'
        GITHUB_CLIENT_ID: Iv1.600bf90a20f1ab18
  staging:
    config:
      environmentVariables:
        APP_URL: https://github-for-jira.stg.services.atlassian.com
        WEBHOOK_PROXY_URL: https://github-for-jira.stg.services.atlassian.com/github/events
        INSTANCE_NAME: github-for-jira-stg
        SENTRY_ENVIRONMENT: stg-west
        APP_ID: '119363'
        GITHUB_CLIENT_ID: Iv1.86f9d277ffccd384
    resources:
      - type: globaledge
        name: proxy
        attributes:
          default_vanity_dns: false
          domain:
            - github.stg.atlassian.com
          upstream_address:
            - address: jira-integration-staging.herokuapp.com
          rewrite: jira-integration-staging.herokuapp.com
          ip_whitelist:
            - public

  prod:
    config:
      environmentVariables:
        APP_URL:  https://github-for-jira.services.atlassian.com
        WEBHOOK_PROXY_URL:  https://https://github-for-jira.services.atlassian.com/github/events
        INSTANCE_NAME: github-for-jira-production
        SENTRY_ENVIRONMENT: production
        APP_ID: '125082'
        GITHUB_CLIENT_ID: Iv1.234a3f06f2b64fbe
    resources:
      - name: rds
        type: dedicated-rds
        attributes:
          parameters:
            DBInstanceClass: db.t3.large

      - type: globaledge
        name: proxy
        attributes:
          default_vanity_dns: false
          domain:
            - github.atlassian.com
          upstream_address:
            - address: jira-integration-production.herokuapp.com
          rewrite: jira-integration-production.herokuapp.com
          ip_whitelist:
            - public
