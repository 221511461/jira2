buildNumber: 0.0.0
name: Github For Jira
description: Connect app for integrating GitHub into Jira
organization: Engineering-DevOps
notifications:
  email: fusion-arc@atlassian.com

compose:
  microservice:
    image: ${DOCKER_IMAGE_NAME}
    tag: ${DOCKER_IMAGE_TAG}
    ports:
    - 8080:8080

links:
  healthcheck:
    uri: healthcheck
  source:
    url: git@bitbucket.org:atlassian/github-jira-integration.git

cleanup: true

resources:
  - type: redis
    name: bottleneck
    attributes:
      snapshotRetention: 0
      config:
        maxmemory-policy: allkeys-lru
  - type: postgres-db
    name: database
  - type: globaledge
    name: ingress
    attributes:
      routes:
        - match:
            prefix: /
            ip_whitelist:
              - public

config:
  environmentVariables:
    NODE_ENV: production
    NODE_OPTIONS: "--no-deprecation"
    LOG_LEVEL: debug

environmentOverrides:
  ddev:
    loadBalancer:
      type: ELB # needed for remote debugging, default is "ALB"
    compose:
      microservice:
        ports:
          - 8080:8080
          - 5005:5005 # remote debugging port (has to be 5005 because that is hard coded into Micros)
    links:
      remoteDebug: true
    config:
      environmentVariables:
        APP_URL: https://github-for-jira.dev.services.atlassian.com
        WEBHOOK_SECRET: development
        WEBHOOK_PROXY_URL: https://github-for-jira.dev.services.atlassian.com/github/events
        INSTANCE_NAME: github-for-jira-dev
        NODE_OPTIONS: "--no-deprecation --inspect=0.0.0.0:5005"
        TUNNEL_PORT: "8080"
        PORT: "8080"
        TUNNEL_SUBDOMAIN: github-for-jira
  staging:
    config:
      environmentVariables:
        APP_URL: INVALID
        INSTANCE_NAME: github-for-jira-staging
  prod:
    config:
      environmentVariables:
        APP_URL: INVALID
        INSTANCE_NAME: github-for-jira-production

scaling:
  min: 1
  max: 1
  instanceCount: 1
  instance: t3.small
