buildNumber: 0.0.0
name: Github For Jira
description: Connect app for integrating GitHub into Jira
organization: Engineering-DevOps
notifications:
  email: fusion-arc@atlassian.com
tags:
  brahmos: enabled

compose:
  pgbouncer:
    image: docker.atl-paas.net/sox/micros/pgbouncer
    tag: 1.15.0
    command: [ "database" ]
  microservice:
    image: ${DOCKER_IMAGE_NAME}
    tag: ${DOCKER_IMAGE_TAG}
    ports:
      - 8080:8080
    links:
      - pgbouncer
      - cryptor
    depends_on:
      - cryptor
  cryptor:
    image: docker.atl-paas.net/sox/cryptor-sidecar-application
    tag: 1.1-stable-release

computeClassification:
  dataType:
    - UGC/Label                # name of GitHub org / Jira site
    - PII/IndirectConfidential # name of GitHub org
    - UGC/Configuration        # data about the installation of the GitHub app into Jira sites
    - Security/Secret          # shared Connect secret
    - UGC/PrimaryIdentifier    # references to GitHub entities (commits, pull requests, etc.) and Jira issues
    - UGC/Primary              # GitHub entities (non-persistent) like commits, pull requests, etc.

links:
  healthcheck:
    uri: healthcheck
  deepcheck:
    uri: deepcheck
  source:
    url: git@bitbucket.org:atlassian/github-jira-integration.git

httpRedirect: true

cleanup: false

lifecycleEvents:
  source: queue
  # Number of seconds between the termination message and when the instance is terminated.
  timeout: 30

resources:
  - type: redisx
    name: cache
    attributes:
      version: 6.x
      size: 500
      clusterModeEnabled: false
      transitEncryptionEnabled: true
      dataType:
        - UGC/Label                # name of GitHub org / Jira site
        - PII/IndirectConfidential # name of GitHub org
        - UGC/PrimaryIdentifier    # references to GitHub entities (commits, pull requests, etc.) and Jira issues

  - type: sqs
    name: backfill
    attributes:
      MaxReceiveCount: 3
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 602 #Visibility timeout will be overridden by the SQS Listener when we read message from the queue. We set it here anyway in case if that override fails.
      dataType:
        - UGC/Label                # name of GitHub org
        - PII/IndirectConfidential # name of GitHub org

  - type: sqs
    name: push
    attributes:
      MaxReceiveCount: 5
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 62 #Visibility timeout will be overridden by the SQS Listener when we read message from the queue. We set it here anyway in case if that override fails
      dataType:
        - UGC/Label                # name of GitHub org
        - PII/IndirectConfidential # name of GitHub org
        - UGC/PrimaryIdentifier    # references to GitHub entities (commits, pull requests, etc.) and Jira issues

  - type: sqs
    name: deployment
    attributes:
      MaxReceiveCount: 5
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 62 #Visibility timeout will be overridden by the SQS Listener when we read message from the queue. We set it here anyway in case if that override fails
      dataType:
        - UGC/Label                # name of GitHub org, URL/name of Jira site
        - PII/IndirectConfidential # name of GitHub org
        - UGC/PrimaryIdentifier    # references to GitHub entities (commits, pull requests, etc.) and Jira issues

  - type: sqs
    name: branch
    attributes:
      MaxReceiveCount: 5
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 62 #Visibility timeout will be overridden by the SQS Listener when we read message from the queue. We set it here anyway in case if that override fails
      dataType:
        - UGC/Label                # name of GitHub org, URL/name of Jira site
        - PII/IndirectConfidential # name of GitHub org
        - UGC/PrimaryIdentifier    # references to GitHub entities (commits, pull requests, etc.) and Jira issues

  - name: rds
    type: dedicated-rds
    attributes:
      dataType:
        - UGC/Label                # name of GitHub org / Jira site
        - PII/IndirectConfidential # name of GitHub org
      parameters:
        DBType: postgres1211
        CustomParameters:
          log_min_duration_statement: 5000

  - name: database
    type: postgres-db
    attributes:
      connectionLimit: 150 # keep in sync with PGBOUNCER_DEFAULT_POOL_SIZE.
        # For ddev and staging we have scaling policy different from prod: up to 5 Worker and up to 5 WebServer nodes.
        # Therefore, when all the nodes are running, we might have up to "PGBOUNCER_DEFAULT_POOL_SIZE * 10" number
        # of connections.
      dataType:
        - UGC/Label                # name of GitHub org / Jira site
        - PII/IndirectConfidential # name of GitHub org
        - UGC/Configuration        # data about the installation of the GitHub app into Jira sites
        - Security/Secret          # shared Connect secret
      dedicatedRds:
        # Name of the service that owns the RDS
        service: github-for-jira
        # Name of the RDS resource from above
        resource: rds

  - name: deployment-history-cache
    type: dynamo-db
    attributes: &table-attributes
      HashKeyName: Id
      HashKeyType: "S"
      RangeKeyName: CreatedAt
      RangeKeyType: "N"
      ReadWriteCapacityMode: ON_DEMAND
      TTLAttributeName: ExpiredAfter
      dataType:

serviceProxy:
  enabled: true
  ingress:
    authentication:
      enabled: true
  egress:
    dependencies:
      - name: rollcall

  plugins:
    auth:
      authentication:
        plugins:
          - type: asap
          - type: slauthtoken
      authorization:
        plugins:
          - type: poco

environmentOverrides:
  ddev:
    scaling:
      min: 2
      max: 3
      instance: m5.large
  stg-west:
    scaling:
      min: 1
      max: 3
      instance: t3.small
    serviceProxy:
      egress:
        dependencies:
          - name: rollcall
  prod-east:
    scaling:
      min: 2
      max: 3
      instance: m5.large
