FROM node:14.18-alpine3.15 as build

# adding python for node-gyp
RUN apk add g++ make python3

# adding to solve vuln
RUN apk add --update --upgrade busybox

WORKDIR /app
COPY . .

# Installing packages
# RUN npm ci (running in the pipeline)

# Building TypeScript files
RUN npm run build:release

FROM node:14.18-alpine3.15
USER node
COPY --chown=node:node --from=build /app /app
WORKDIR /app
ENV NODE_ENV production

CMD ["./bin/start-server-micros.sh"]
